<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Load Balancer WebSocket Test</title>
    <script src="https://cdn.jsdelivr.net/npm/@polkadot/api@latest/bundle-polkadot-api.js"></script>
    <style>
        body {
            font-family: monospace;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #1e1e1e;
            color: #00ff00;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { background: #0a4d0a; }
        .error { background: #4d0a0a; }
        .info { background: #0a0a4d; }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            font-family: monospace;
        }
        button:hover { background: #00cc00; }
        #log {
            background: #000;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            border: 1px solid #00ff00;
            margin-top: 20px;
        }
        .timestamp { color: #888; }
    </style>
</head>
<body>
    <h1>üîó Load Balancer WebSocket Test</h1>
    <p><strong>Endpoint:</strong> wss://substrate-compute-27586.duckdns.org</p>

    <div id="status" class="status info">Status: Not connected</div>

    <button onclick="testPolkadotAPI()">Test Polkadot.js API</button>
    <button onclick="testRawWebSocket()">Test Raw WebSocket</button>
    <button onclick="clearLog()">Clear Log</button>

    <div id="log"></div>

    <script>
        const endpoint = 'wss://substrate-compute-27586.duckdns.org';
        let api = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff0000' : type === 'success' ? '#00ff00' : '#00ccff';
            logDiv.innerHTML += `<div><span class="timestamp">[${timestamp}]</span> <span style="color:${color}">${message}</span></div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = 'Status: ' + message;
            statusDiv.className = 'status ' + type;
        }

        async function testPolkadotAPI() {
            log('üöÄ Testing Polkadot.js API connection...');
            updateStatus('Connecting to Polkadot API...', 'info');

            try {
                const wsProvider = new polkadotApi.WsProvider(endpoint);

                wsProvider.on('connected', () => {
                    log('‚úÖ WebSocket connected!', 'success');
                    updateStatus('WebSocket connected', 'success');
                });

                wsProvider.on('disconnected', () => {
                    log('‚ùå WebSocket disconnected', 'error');
                    updateStatus('WebSocket disconnected', 'error');
                });

                wsProvider.on('error', (error) => {
                    log('‚ùå WebSocket error: ' + error.message, 'error');
                    updateStatus('WebSocket error', 'error');
                });

                log('üì° Creating API instance...');
                api = await polkadotApi.ApiPromise.create({ provider: wsProvider });

                log('‚úÖ API connected successfully!', 'success');
                updateStatus('API connected', 'success');

                // Get chain info
                const chain = await api.rpc.system.chain();
                const version = await api.rpc.system.version();
                const health = await api.rpc.system.health();

                log(`üìä Chain: ${chain}`, 'success');
                log(`üìä Version: ${version}`, 'success');
                log(`üìä Peers: ${health.peers}`, 'success');
                log(`üìä Syncing: ${health.isSyncing}`, 'success');

                // Get latest block
                const lastHeader = await api.rpc.chain.getHeader();
                log(`üìä Latest block: #${lastHeader.number}`, 'success');

                updateStatus(`Connected to ${chain} - ${health.peers} peers`, 'success');

            } catch (error) {
                log('‚ùå Failed to connect: ' + error.message, 'error');
                updateStatus('Connection failed', 'error');
                console.error(error);
            }
        }

        function testRawWebSocket() {
            log('üîå Testing raw WebSocket connection...');
            updateStatus('Testing raw WebSocket...', 'info');

            const ws = new WebSocket(endpoint);

            ws.onopen = () => {
                log('‚úÖ Raw WebSocket opened!', 'success');
                updateStatus('Raw WebSocket connected', 'success');

                // Send RPC request
                const rpcRequest = JSON.stringify({
                    id: 1,
                    jsonrpc: '2.0',
                    method: 'system_chain',
                    params: []
                });
                log('üì§ Sending: ' + rpcRequest);
                ws.send(rpcRequest);
            };

            ws.onmessage = (event) => {
                log('üì• Received: ' + event.data, 'success');
                try {
                    const response = JSON.parse(event.data);
                    if (response.result) {
                        log('‚úÖ Chain name: ' + response.result, 'success');
                        updateStatus('Raw WebSocket working - Chain: ' + response.result, 'success');
                    }
                } catch (e) {
                    log('‚ö†Ô∏è Non-JSON response', 'info');
                }
            };

            ws.onerror = (error) => {
                log('‚ùå WebSocket error: ' + error, 'error');
                updateStatus('WebSocket error', 'error');
            };

            ws.onclose = (event) => {
                log(`üîå WebSocket closed: Code ${event.code} - ${event.reason || 'No reason'}`, 'info');
                if (event.code === 1006) {
                    log('‚ö†Ô∏è Abnormal closure detected', 'error');
                }
            };
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('Log cleared');
        }

        // Auto-test on load
        log('Ready to test. Click "Test Polkadot.js API" to begin.');
    </script>
</body>
</html>
